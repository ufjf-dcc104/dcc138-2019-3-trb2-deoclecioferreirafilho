<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>### Grunch ###</title>
    <script src="Sprite.js"></script>
    <script src="Scene.js"></script>
    <script src="AssetsManager.js"></script>
    <script src="Map.js"></script>

</head>

<body>

    <canvas></canvas>
    <script>
        var assetsMng = new AssetsManager();
        assetsMng.loadImage("image", "assets/blowharder.png");
        assetsMng.loadImage("tiles", "assets/tiles.png");
        assetsMng.loadImage("blocos", "assets/blocos.png");
        assetsMng.loadImage("grama", "assets/grass.jpg");
        assetsMng.loadImage("grunch", "assets/grunch.png");
        assetsMng.loadImage("ladygreen", "assets/ladygreen.png");
        assetsMng.loadImage("osos", "assets/osos.png");
        // assetsMng.loadAudio("shot", "assets/shot.mp3");

        var canvas = document.querySelector("canvas");
        canvas.width = 640;
        canvas.height = 640;
        var ctx = canvas.getContext("2d");
        var teclas = {
            esquerda: 0,
            cima: 0,
            direita: 0,
            baixo: 0,
            espaco: 0
        }
        var mapa = new Map({
            COLUMNS: 20, LINES: 20, m:
                [
                    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                    [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1],
                    [1, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1],
                    [1, 0, 0, 0, 0, 0, 1, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1],
                    [1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                    [1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                    [1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1],
                    [1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1],
                    [1, 0, 1, 1, 1, 1, 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                    [1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1],
                    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                    [1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1],
                    [1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1],
                    [1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1],
                    [1, 0, 0, 1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1],
                    [1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1],
                    [1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                    [1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1],
                    [1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1],
                    [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
                ]
        });


        var cena1 = new Scene({ ctx: ctx, w: canvas.width, h: canvas.height, assets: assetsMng, map: mapa });
        mapa.scene = cena1;



        var pc = new Sprite({ x: 60, y: 60, w: 30, h: 5, speed: 2, pose: 10 * 64, frame: 0, comportar: porTeclasDirecionais(teclas), props: { tipo: "pc" }, desenhar: desenhaPC }); //
        cena1.adicionar(pc);

        // cena1.desenharMuro();

        function desenhaPC(ctx) {
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.strokeStyle = "white";
            // ctx.fillRect(-this.w / 2, -this.h / 2, this.w, this.h);
            ctx.strokeRect(-this.w / 2, -this.h / 2, this.w, this.h);

            ctx.drawImage(
                this.scene.assets.img("grunch"),
                // (this.poses[this.pose].c + Math.floor(this.frame)) * 64,this.poses[this.pose].l * 64,
                //Math.floor(this.frame) * 64,
                this.frame,
                this.pose,
                64,
                64,
                -64 / 2,
                1 - 64,
                64,
                64
            );


            ctx.restore();
        }

        function blocoRet(pcA, muroB) {
            var distX = (pcA.x + (pcA.w/2)) - (muroB.x + (muroB.width / 2));
            var distY = (pcA.y + (pcA.h/2)) - (muroB.y + (muroB.height / 2));
            var somaWidth = (pcA.w + muroB.width) / 2;
            var somaHeight = (pcA.h + muroB.height) / 2;
           // console.log(distX  , distY);
          //  console.log(somaWidth, somaHeight);
           
           if (Math.abs(distX) < somaWidth && Math.abs(distY) < somaHeight) {
               var overlapX = somaWidth - Math.abs(distX);
               var overlapY = somaHeight - Math.abs(distY);
              //  console.log(overlapX, overlapY);
               
                if (overlapX > overlapY) {
                    pcA.y = distY > 0 ? pcA.y + overlapY : pcA.y - overlapY;
                } else {
                    pcA.x = distX > 0 ? pcA.x + overlapX : pcA.x - overlapX;
                }
            }
        }

        var muros = [];
        function desenhaMuro() {
            for (var c = 0; c < mapa.COLUMNS; c++) {
                for (var l = 0; l < mapa.LINES; l++) {

                    if (mapa.m[c][l] === 1) {
                        var muro = {
                            x: c * mapa.SIZE,
                            y: l * mapa.SIZE,
                            width: mapa.SIZE,
                            height: mapa.SIZE
                        };
                        muros.push(muro);
                       // console.log(muro);
                       // console.log(muro.x, muro.y);
                    }
                }
               //console.log(muros[c]);
            }
        }

        desenhaMuro();

        function porTeclasDirecionais(teclas) {
            return function () {
                if (teclas.esquerda && !teclas.direita) {
                    this.x -= this.speed;
                    this.pose = (8 * 64) + (64 * 1)
                }
                if (teclas.direita && !teclas.esquerda) {
                    this.x += this.speed;
                    this.pose = (8 * 64) + (64 * 3)

                }

                if (teclas.cima && !teclas.baixo) {
                    this.y -= this.speed;
                    this.pose = (8 * 64) + (64 * 0)

                }
                if (teclas.baixo && !teclas.cima) {
                    this.y += this.speed;
                    this.pose = (8 * 64) + (64 * 2)

                }
                if (teclas.esquerda || teclas.direita || teclas.cima || teclas.baixo) {
                    this.countAnim++;
                    if (this.countAnim >= 40) { this.countAnim = 0 };
                    this.frame = Math.floor(this.countAnim / 5) * 64;


                    for (var i = 0;i < muros.length; i++) {
                        var muro = muros[i];
                        blocoRet(this, muro);
                        console.log(muros[i]);
                        // console.log(mapa.muros[1])
                        //console.log(muro.x);
                    }

                } else {
                    this.frame = 0;
                    this.countAnim = 0;
                }


                /*
                            if (teclas.espaco && this.cooldown <= 0) {
                                var tiro = new Sprite({
                                    x: this.x, y: this.y,
                                    a: this.a - 0.1 + 0.2 * Math.random(),
                                    vm: 240, color: "green", w: 4, h: 4,
                                    props: { tipo: "tiro" }
                                });
                                this.scene.adicionar(tiro);
                                this.cooldown = 0.1;
                                assetsMng.play("shot");
                            }
                */
            }
        }



        addEventListener("keydown", function (e) {
            switch (e.keyCode) {
                case 32:
                    teclas.espaco = 1;
                    break;
                case 37:
                    teclas.esquerda = 1;
                    break;
                case 38:
                    teclas.cima = 1;
                    break;
                case 39:
                    teclas.direita = 1;
                    break;
                case 40:
                    teclas.baixo = 1;
                    break;
            }
        });
        addEventListener("keyup", function (e) {
            switch (e.keyCode) {
                case 32:
                    teclas.espaco = 0;
                    break;
                case 37:
                    teclas.esquerda = 0;
                    break;
                case 38:
                    teclas.cima = 0;
                    break;
                case 39:
                    teclas.direita = 0;
                    break;
                case 40:
                    teclas.baixo = 0;
                    break;
            }
        });


        function passo(t) {
            dt = (t - anterior) / 1000;
            if (assetsMng.progresso() === 100) {
                cena1.passo(dt);

            }
            anterior = t;
            ctx.fillStyle = "white";
            ctx.font = "20px verdana";
            ctx.fillText(Math.floor(1 / dt), 10, 25);

            requestAnimationFrame(passo);
        }

        var dt, anterior = 0;
        requestAnimationFrame(passo);

    </script>
</body>

</html>