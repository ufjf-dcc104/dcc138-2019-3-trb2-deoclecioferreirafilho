<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>### Grunch ###</title>
    <script src="Sprite.js"></script>
    <script src="Scene.js"></script>
    <script src="AssetsManager.js"></script>
    <script src="Map.js"></script>
    <script src="Explosion.js"></script>

</head>

<body>

    <canvas></canvas>
    <script>
        var assetsMng = new AssetsManager();
        assetsMng.loadImage("image", "assets/blowharder.png");
        assetsMng.loadImage("tiles", "assets/tiles.png");
        assetsMng.loadImage("blocos", "assets/blocos.png");
        assetsMng.loadImage("grama", "assets/grass.jpg");
        assetsMng.loadImage("grunch", "assets/grunch.png");
        assetsMng.loadImage("grunchArrow", "assets/grunch_f.png");
        assetsMng.loadImage("ladygreen", "assets/ladygreen.png");
        assetsMng.loadImage("osos", "assets/osos.png");
        assetsMng.loadImage("arrow64", "assets/arrow64.png");
        assetsMng.loadAudio("explosion", "assets/explosion.mp3");
        assetsMng.loadImage("explosion", "assets/explosion.png");

        // assetsMng.loadAudio("shot", "assets/shot.mp3");
        var imagensPC = "grunchArrow";
        var canvas = document.querySelector("canvas");
        canvas.width = 640;
        canvas.height = 640;
        var ctx = canvas.getContext("2d");
        var teclas = {
            esquerda: 0,
            cima: 0,
            direita: 0,
            baixo: 0,
            espaco: 0
        }
        var mapa = new Map({
            m:
                [
                    [1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2, 1, 2],
                    [3, 4, 3, 4, 8, 7, 8, 7, 8, 7, 8, 7, 8, 7, 8, 7, 8, 7, 8, 7],
                    [1, 2, 4, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5],
                    [3, 4, 8, 0, 0, 0, 0, 0, 0, 31, 21, 21, 0, 0, 0, 0, 26, 0, 0, 7],
                    [1, 8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 9],
                    [3, 6, 0, 0, 32, 33, 0, 0, 0, 27, 28, 0, 5, 6, 0, 0, 0, 0, 0, 11],
                    [1, 8, 0, 32, 32, 0, 0, 0, 0, 0, 29, 30, 7, 8, 0, 27, 28, 0, 0, 9],
                    [3, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11],
                    [1, 8, 0, 0, 0, 0, 0, 0, 20, 25, 25, 0, 0, 0, 0, 0, 0, 0, 0, 9],
                    [3, 6, 0, 0, 0, 9, 10, 0, 0, , 25, 0, 0, 0, 0, 0, 9, 10, 0, 11],
                    [1, 8, 0, 0, 0, 11, 12, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 12, 0, 9],
                    [8, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11],
                    [31, 0, 0, 0, 0, 34, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5],
                    [31, 0, 0, 17, 34, 34, 0, 0, 0, 0, 9, 10, 0, 0, 0, 0, 0, 0, 0, 7],
                    [35, 36, 0, 19, 0, 0, 0, 0, 0, 9, 13, 14, 10, 0, 22, 0, 0, 0, 0, 5],
                    [37, 38, 0, 0, 0, 0, 0, 0, 0, 11, 15, 16, 12, 0, 23, 23, 0, 0, 0, 7],
                    [31, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 12, 0, 0, 0, 0, 21, 0, 0, 5],
                    [9, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 1],
                    [13, 14, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 5, 1, 2],
                    [15, 16, 12, 5, 6, 5, 6, 5, 6, 5, 6, 5, 6, 5, 6, 5, 6, 7, 8, 7]
                ]
        });


        var cena1 = new Scene({ ctx: ctx, w: canvas.width, h: canvas.height, assets: assetsMng, map: mapa });
        mapa.scene = cena1;


        var boom = new Explosion({ x: 100, y: 100, w: 64, h: 64 });
        var pc = new Sprite({ x: 250, y: 200, w: 22, h: 5, speed: 2, pose: 10 * 64, frame: 0, comportar: porTeclasDirecionais(teclas), props: { tipo: "pc" }, desenhar: desenhaPC });
        cena1.adicionar(pc);

         for (var k = 0; k < 10; k++) {
                cena1.adicionar(new Sprite({
                    x: 300 * Math.random(),
                    y: 400 * Math.random(),
                    w: 32,
                    h: 32,
                    va: 2 * Math.random(),
                    vm: 40 * Math.random(),
                    color: "red", comportar: persegue2(pc), props: { tipo: "npc" },
                    desenhar: desenhaNPC
                }));
            }


        var direcaoPC = 2;
        var sizePC = 64;

        // cena1.desenharMuro();

        function desenhaPC(ctx) {
            ctx.save();
            ctx.translate(this.x, this.y);

            // ctx.fillRect(-this.w / 2, -this.h / 2, this.w, this.h);
            ctx.strokeStyle = "yellow";
            ctx.strokeRect(-this.w / 2, -this.h / 2, this.w, this.h);
            ctx.drawImage(
                this.scene.assets.img(imagensPC),
                // (this.poses[this.pose].c + Math.floor(this.frame)) * 64,this.poses[this.pose].l * 64,
                //Math.floor(this.frame) * 64,
                this.frame,
                this.pose,
                sizePC,
                sizePC,
                -sizePC + 40,
                -sizePC + 15,
                sizePC - 15,
                sizePC - 15
            );

            ctx.restore();
        }

         function desenhaNPC() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.a + Math.PI / 2);
                ctx.drawImage(
                    this.scene.assets.img("osos"),
              this.frame,
                    this.pose,
                    sizePC,
                    sizePC,
                    -sizePC + 40,
                    -sizePC + 15,
                    sizePC - 15,
                    sizePC - 15
                );
                ctx.restore();
            }

            function persegue2(alvo) {
                return function () {
                    var dx = alvo.x - this.x;
                    var dy = alvo.y - this.y;
                    var da = Math.sqrt(dx * dx + dy * dy);
                    var adj = Math.PI / 2;
                    var prod = (dx / da) * Math.cos(this.a + adj) +
                        (dy / da) * Math.sin(this.a + adj);
                    this.va = 2 * (prod - 0);
                    //this.vm = 30;
                }
            }


        function blocoRet(pcA, muroB) {
            var distX = (pcA.x + pcA.w / 2) - (muroB.x + (muroB.width / 2));
            var distY = (pcA.y + pcA.h / 2) - (muroB.y + (muroB.height / 2));
            var somaWidth = (pcA.w + muroB.width) / 2;
            var somaHeight = (pcA.h + muroB.height) / 2;

            if (Math.abs(distX) < somaWidth && Math.abs(distY) < somaHeight) {
                var overlapX = somaWidth - Math.abs(distX);
                var overlapY = somaHeight - Math.abs(distY);


                // console.log("somaW: ", somaWidth, "somaH", somaHeight);
                // console.log("distY: ", distY, "distX: ", distX);
                // console.log("overX: ", overlapX, "overY: ", overlapY);
                if (overlapX > overlapY) {
                    //  console.log("antes pcA.y: ", pcA.y);
                    pcA.y = distY > 0 ? pcA.y + overlapY : pcA.y - overlapY;
                    //  console.log("pcA.y: ", pcA.y);
                } else {
                    // console.log("antes pcA.x: ", pcA.x);
                    pcA.x = distX > 0 ? pcA.x + overlapX : pcA.x - overlapX;
                    // console.log("pcA.x: ", pcA.x);
                }
            }
        }

        var muros = [];
        function desenhaMuro() {
            for (var c = 0; c < mapa.COLUMNS; c++) {
                for (var l = 0; l < mapa.LINES; l++) {

                    if (mapa.m[l][c] != 0) {
                        var muro = {
                            x: c * mapa.SIZE,
                            y: l * mapa.SIZE,
                            width: mapa.SIZE,
                            height: mapa.SIZE
                        };
                        muros.push(muro);
                    }
                }
            }
        }

        desenhaMuro();

        function porTeclasDirecionais(teclas) {
            return function () {

                if (teclas.esquerda && !teclas.direita) {
                    this.x -= this.speed;
                    this.pose = (8 * sizePC) + (sizePC * 1)
                    direcaoPC = 1;
                }
                if (teclas.direita && !teclas.esquerda) {
                    this.x += this.speed;
                    this.pose = (8 * sizePC) + (sizePC * 3)
                    direcaoPC = 3;
                }

                if (teclas.cima && !teclas.baixo) {
                    this.y -= this.speed;
                    this.pose = (8 * sizePC) + (sizePC * 0)
                    direcaoPC = 0;
                }
                if (teclas.baixo && !teclas.cima) {
                    this.y += this.speed;
                    this.pose = (8 * sizePC) + (sizePC * 2)
                    direcaoPC = 2;
                }
                if (teclas.esquerda || teclas.direita || teclas.cima || teclas.baixo) {
                    this.countAnim++;
                    if (this.countAnim >= 40) { this.countAnim = 0 };
                    this.frame = Math.floor(this.countAnim / 5) * sizePC;

                    for (var i = 0; i < muros.length; i++) {
                        var muro = muros[i];
                        blocoRet(this, muro);
                    }
                } else {
                    this.frame = 0;
                    this.countAnim = 0;
                }



                if (teclas.espaco && this.cooldown <= 0) {

                    var F = Math.floor(dt * 8 * 10)*96;
                    var x = 36
                    this.frame = Math.floor(x/ 12) * sizePC;

                    console.log("F: ", F, this.frame);
                    console.log(dt, sizePC);
                    if(F >= x) {F = 0;};
                    console.log( "dt: ", dt, "frame:", this.frame);
 
                    var tiro = new Sprite({
                        x: this.x,
                        y: this.y - 29,
                        color: "green",
                        w: 4,
                        h: 4,
                        speed: 10,
                        props: { tipo: "tiro" },
                        rotate: (this.a + Math.PI),
                        comportar: vtiro,
                        desenhar: desenhaArrow
                    });
                    this.scene.adicionar(tiro);

                    this.cooldown = 0.8;

                }

            }
        }

        function moverTiro(dt) {
            this.frame += 6 * dt;
            if (this.frame > 12) { this.frame = 0 }
           // console.log(dt);
        }

        
        function animaPCArrow(dt) {
            pc.frame += 2* dt/1000;
            //console.log(pc.frame);
            
            if (Math.floor(this.frame) > 12) {
                this.frame = 0;

            }

        }

        function vtiro() {

            animaPCArrow(dt);
            if (direcaoPC === 1) { // esquerda

                pc.pose = (16 * sizePC) + (sizePC * 1);
                this.x -= this.speed;
                //this.posTiropc.x = -sizePC / 2;
                //this.posTiropc.y =  this.y +100;
            }

            if (direcaoPC === 3) { // direita
                pc.pose = (16 * sizePC) + (sizePC * 3);
                this.x += this.speed;
                //this.posTiropc.x = -sizePC / 2;
                //this.posTiropc.y = -sizePC / 2;

            }
            if (direcaoPC === 0) {
                pc.pose = (16 * sizePC) + (sizePC * 0);
                this.y -= this.speed;
                this.posTiropc.x = -sizePC / 2;
                this.posTiropc.y = -sizePC / 2;

            }
            if (direcaoPC === 2) {
                pc.pose = (16 * sizePC) + (sizePC * 2);
                this.y += this.speed;
                this.posTiropc.x = -sizePC / 2;
                this.posTiropc.y = -sizePC / 2;

            }


        }

        function desenhaArrow(ctx) {
            ctx.save();
            ctx.drawImage(
                this.scene.assets.img("arrow64"),
                direcaoPC * sizePC,
                this.pose,
                sizePC,
                sizePC,
                this.x + this.posTiropc.x / 2,
                this.y - 15,
                sizePC / 2,
                sizePC / 2
            );
            ctx.restore();
        }


        addEventListener("keydown", function (e) {
            switch (e.keyCode) {
                case 32:
                    teclas.espaco = 1;
                    break;
                case 37:
                    teclas.esquerda = 1;
                    break;
                case 38:
                    teclas.cima = 1;
                    break;
                case 39:
                    teclas.direita = 1;
                    break;
                case 40:
                    teclas.baixo = 1;
                    break;
            }
        });
        addEventListener("keyup", function (e) {
            switch (e.keyCode) {
                case 32:
                    teclas.espaco = 0;
                    break;
                case 37:
                    teclas.esquerda = 0;
                    break;
                case 38:
                    teclas.cima = 0;
                    break;
                case 39:
                    teclas.direita = 0;
                    break;
                case 40:
                    teclas.baixo = 0;
                    break;
            }
        });


        function passo(t) {
            dt = (t - anterior) / 1000;
            if (assetsMng.progresso() === 100) {
                cena1.passo(dt);
            }


            anterior = t;
            ctx.fillStyle = "white";
            ctx.font = "20px verdana";
            ctx.fillText(Math.floor(1 / dt), 10, 25);
            
            requestAnimationFrame(passo);
           
           animaPCArrow(dt);          
        }


        var dt, anterior = 0;
        requestAnimationFrame(passo);
       

    </script>
</body>

</html>